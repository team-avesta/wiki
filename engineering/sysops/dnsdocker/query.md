# Dns testing


## Redundancy with multiple nameservers


Testing with 2 dns servers, one on 192.168.0.50 and other on 192.168.0.51, these addresses are allocated to the clients by dhcp server, we can check it in client configuration using:

```
sudo nano /etc/resolv.conf
```

It should look like as follows, the client will use the first server by default and if it doesnt get required response it will move on down the lines
```
# Generated by resolvconf
nameserver 192.168.0.50
nameserver 192.168.0.51

```

##### Case 1 & 2

Testing with both Servers up

```
 host  www.google.com
www.google.com has address 216.58.199.164
www.google.com has IPv6 address 2404:6800:4009:807::2004
pi@raspberrypi:~/test $ host -v www.google.com
Trying "www.google.com"
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 14351
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 4

;; QUESTION SECTION:
;www.google.com.                        IN      A

;; ANSWER SECTION:
www.google.com.         199     IN      A       216.58.199.164

;; AUTHORITY SECTION:
google.com.             172699  IN      NS      ns3.google.com.
google.com.             172699  IN      NS      ns2.google.com.
google.com.             172699  IN      NS      ns1.google.com.
google.com.             172699  IN      NS      ns4.google.com.

;; ADDITIONAL SECTION:
ns1.google.com.         172699  IN      A       216.239.32.10
ns2.google.com.         172699  IN      A       216.239.34.10
ns3.google.com.         172699  IN      A       216.239.36.10
ns4.google.com.         172699  IN      A       216.239.38.10

Received 184 bytes from 192.168.0.50#53 in 4 ms
Trying "www.google.com"
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 47718
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 4

;; QUESTION SECTION:
;www.google.com.                        IN      AAAA

;; ANSWER SECTION:
www.google.com.         200     IN      AAAA    2404:6800:4009:807::2004

;; AUTHORITY SECTION:
google.com.             172699  IN      NS      ns1.google.com.
google.com.             172699  IN      NS      ns2.google.com.
google.com.             172699  IN      NS      ns3.google.com.
google.com.             172699  IN      NS      ns4.google.com.

;; ADDITIONAL SECTION:
ns1.google.com.         172699  IN      A       216.239.32.10
ns2.google.com.         172699  IN      A       216.239.34.10
ns3.google.com.         172699  IN      A       216.239.36.10
ns4.google.com.         172699  IN      A       216.239.38.10

Received 196 bytes from 192.168.0.50#53 in 4 ms
Trying "www.google.com"
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61127
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0

;; QUESTION SECTION:
;www.google.com.                        IN      MX

;; AUTHORITY SECTION:
google.com.             34      IN      SOA     ns4.google.com. dns-admin.google.com. 163641508 900 900 1800 60

Received 82 bytes from 192.168.0.50#53 in 1 ms
```

As we can see we got our response from the first nameserver, in the config file.

Case 2: This same response we get for first server only running and second one down. 



##### Case 3

Now testing for first server down, and only second server running:

```
host -v www.google.com
Trying "www.google.com"
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 13204
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 4

;; QUESTION SECTION:
;www.google.com.                        IN      A

;; ANSWER SECTION:
www.google.com.         300     IN      A       216.58.199.164

;; AUTHORITY SECTION:
google.com.             172800  IN      NS      ns1.google.com.
google.com.             172800  IN      NS      ns3.google.com.
google.com.             172800  IN      NS      ns2.google.com.
google.com.             172800  IN      NS      ns4.google.com.

;; ADDITIONAL SECTION:
ns1.google.com.         172800  IN      A       216.239.32.10
ns2.google.com.         172800  IN      A       216.239.34.10
ns3.google.com.         172800  IN      A       216.239.36.10
ns4.google.com.         172800  IN      A       216.239.38.10

Received 184 bytes from 192.168.0.51#53 in 458 ms
Trying "www.google.com"
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 8511
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 4

;; QUESTION SECTION:
;www.google.com.                        IN      AAAA

;; ANSWER SECTION:
www.google.com.         300     IN      AAAA    2404:6800:4009:807::2004

;; AUTHORITY SECTION:
google.com.             172799  IN      NS      ns1.google.com.
google.com.             172799  IN      NS      ns4.google.com.
google.com.             172799  IN      NS      ns3.google.com.
google.com.             172799  IN      NS      ns2.google.com.

;; ADDITIONAL SECTION:
ns1.google.com.         172799  IN      A       216.239.32.10
ns2.google.com.         172799  IN      A       216.239.34.10
ns3.google.com.         172799  IN      A       216.239.36.10
ns4.google.com.         172799  IN      A       216.239.38.10

Received 196 bytes from 192.168.0.51#53 in 134 ms
Trying "www.google.com"
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 42905
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0

;; QUESTION SECTION:
;www.google.com.                        IN      MX

;; AUTHORITY SECTION:
google.com.             60      IN      SOA     ns1.google.com. dns-admin.google.com. 163641508 900 900 1800 60

Received 82 bytes from 192.168.0.51#53 in 92 ms


```

As we can see here the client now gets response from the second nameserver, 192.168.0.51 successfully, when the first one is down. 
Hence in case of 2 dns servers, we get response even when one of the servers is unreachable.




## Dns loadtest using dnsperf
[source](http://www.techietown.info/2017/03/load-testing-dns-using-dnsperf/ "techietown link for load-testing using dnsperf")




### Testing DNS server from the same server it is being hosted on.

##### Case 1
We use 50000 queries of a same existing domain name ```www.google.com``` on the BIND DNS server docker.

First we create this file, with 50000 entries of ```www.google.com``` aka the domain name followed by A which refers to the DNS query type
```
 for i in `seq 1 50000`; do echo "www.google.com A" >> g.txt; done;
```
After we created the g.txt file, we test it with dnsperf using

```
dnsperf -s 192.168.0.51 -d g.txt
DNS Performance Testing Tool
Nominum Version 2.1.0.0

[Status] Command line: dnsperf -s 192.168.0.51 -d g.txt
[Status] Sending queries (to 192.168.0.51)
[Status] Started at: Mon Jul 31 12:34:06 2017
[Status] Stopping after 1 run through file
[Timeout] Query timed out: msg id 10
.
.
.
[Timeout] Query timed out: msg id 99
[Status] Testing complete (end of file)

Statistics:

  Queries sent:         50000
  Queries completed:    49910 (99.82%)
  Queries lost:         90 (0.18%)

  Response codes:       NOERROR 49910 (100.00%)
  Average packet size:  request 32, response 184
  Run time (s):         0.581831
  Queries per second:   85780.922639

  Average Latency (s):  0.000102 (min 0.000022, max 0.091588)
  Latency StdDev (s):   0.001247

```


##### Case 2 
We use 50000 queries of a same non-existing domain name ```www.urhgtsukyehvukyuqkyhtuikyrukgyhdkhgkduryteuiy6843.com``` on the BIND DNS server docker.

First we create this file, with 50000 entries of ```www.urhgtsukyehvukyuqkyhtuikyrukgyhdkhgkduryteuiy6843.com``` aka the domain name followed by A which refers to the DNS query type
```
 for i in `seq 1 50000`; do echo "www.urhgtsukyehvukyuqkyhtuikyrukgyhdkhgkduryteuiy6843.com A" >> n.txt; done;
```

After we created the n.txt file, we test it with dnsperf using

```
dnsperf -s 192.168.0.51 -d n.txt
DNS Performance Testing Tool
Nominum Version 2.1.0.0

[Status] Command line: dnsperf -s 192.168.0.51 -d n.txt
[Status] Sending queries (to 192.168.0.51)
[Status] Started at: Mon Jul 31 12:49:33 2017
[Status] Stopping after 1 run through file
[Timeout] Query timed out: msg id 10
[Timeout] Query timed out: msg id 11
.
.
.
.
[Timeout] Query timed out: msg id 98
[Timeout] Query timed out: msg id 99
[Status] Testing complete (end of file)

Statistics:

  Queries sent:         50000
  Queries completed:    49910 (99.82%)
  Queries lost:         90 (0.18%)

  Response codes:       NXDOMAIN 49910 (100.00%)
  Average packet size:  request 75, response 148
  Run time (s):         0.775241
  Queries per second:   64379.979903

  Average Latency (s):  0.000139 (min 0.000012, max 0.455534)
  Latency StdDev (s):   0.006392

```








### Testing DNS server from the another client.

##### Case 1
We use 200000 queries of a same existing domain name ```ww.google.com``` on the BIND DNS server docker.

First we create this file, with 200000 entries of ```www.google.com``` aka the domain name followed by A which refers to the DNS query type
```
 for i in `seq 1 200000`; do echo "www.google.com A" >> g.txt; done;
```
After we created the g.txt file, we test it with dnsperf using

```
dnsperf -s 192.168.0.50 -d g.txt                        
DNS Performance Testing Tool
Nominum Version 2.1.0.0

[Status] Command line: dnsperf -s 192.168.0.50 -d g.txt
[Status] Sending queries (to 192.168.0.50)
[Status] Started at: Mon Jul 31 15:03:39 2017
[Status] Stopping after 1 run through file
[Timeout] Query timed out: msg id 5
[Timeout] Query timed out: msg id 11
.
.
.
.
[Timeout] Query timed out: msg id 41658
[Timeout] Query timed out: msg id 41659
[Status] Testing complete (end of file)

Statistics:

  Queries sent:         200000
  Queries completed:    199818 (99.91%)
  Queries lost:         182 (0.09%)

  Response codes:       NOERROR 199818 (100.00%)
  Average packet size:  request 28, response 180
  Run time (s):         11.502265
  Queries per second:   17372.056721

  Average Latency (s):  0.001811 (min 0.000310, max 0.824139)
  Latency StdDev (s):   0.006399
```




##### Case 2 
We use 200000 queries of a same non-existing domain name ```www.urhgtsukyehvukyuqkyhtuikyrukgyhdkhgkduryteuiy6843.com``` on the BIND DNS server docker.

First we create this file, with 50000 entries of ```www.urhgtsukyehvukyuqkyhtuikyrukgyhdkhgkduryteuiy6843.com``` aka the domain name followed by A which refers to the DNS query type
```
 for i in `seq 1 200000`; do echo "www.urhgtsukyehvukyuqkyhtuikyrukgyhdkhgkduryteuiy6843.com A" >> n.txt; done;
```

After we created the n.txt file, we test it with dnsperf using

```
dnsperf -s 192.168.0.50 -d n.txt
DNS Performance Testing Tool
Nominum Version 2.1.0.0

[Status] Command line: dnsperf -s 192.168.0.50 -d n.txt
[Status] Sending queries (to 192.168.0.50)
[Status] Started at: Mon Jul 31 15:07:08 2017
[Status] Stopping after 1 run through file
[Timeout] Query timed out: msg id 15
[Timeout] Query timed out: msg id 16
[Timeout] Query timed out: msg id 17
.
.
.
.
[Timeout] Query timed out: msg id 3430
[Timeout] Query timed out: msg id 3428
[Status] Testing complete (end of file)

Statistics:

  Queries sent:         200000
  Queries completed:    199823 (99.91%)
  Queries lost:         177 (0.09%)

  Response codes:       NXDOMAIN 199823 (100.00%)
  Average packet size:  request 73, response 146
  Run time (s):         10.104507
  Queries per second:   19775.630815

  Average Latency (s):  0.001538 (min 0.000348, max 0.160103)
  Latency StdDev (s):   0.002761




### Additional Links and resources

* [Github link for dnsperf][1]





[1]:https://github.com/cobblau/dnsperf

